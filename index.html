<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer with Project Tracking</title>
    <style>
        :root {
            --primary-pink: #e91e63;
            --primary-green: #4caf50;
            --primary-purple: #9c27b0;
            --primary-blue: #2196f3;
            --primary-orange: #ff9800;
            --accent-purple: #673ab7;
            --work-bg: #ffebee;
            --break-bg: #e8f5e9;
            --work-text: #e91e63;
            --break-text: #4caf50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary-pink);
            margin: 0;
        }

        .timer-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 4rem;
            text-align: center;
            font-family: monospace;
            margin: 20px 0;
            color: var(--primary-purple);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-blue);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        .mode-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        #start { background-color: var(--primary-green); }
        #stop { background-color: #f44336; display: none; }
        #reset { background-color: var(--primary-orange); }
        #setWorkMode { background-color: var(--primary-pink); }
        #setBreakMode { background-color: var(--primary-green); }

        .tracking-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .tracking-box {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tracking-box h2 {
            margin-top: 0;
            font-size: 1.2rem;
            color: var(--primary-purple);
        }

        .project-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .project-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .project-item:hover {
            background-color: #f5f5f5;
        }

        .project-item.selected {
            background-color: #e1bee7;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-name {
            font-weight: bold;
        }

        .project-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .project-notes {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: none;
        }

        .project-item.expanded .project-notes {
            display: block;
        }

        .note-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: white;
            border-left: 3px solid var(--primary-blue);
            font-size: 0.9rem;
        }

        .note-time {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .note-text {
            margin: 5px 0;
        }

        .add-note {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-note input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .add-note button {
            padding: 8px 15px;
        }

        .calendar-container {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 5px;
            color: var(--primary-purple);
        }

        .calendar-day {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-day:hover {
            background-color: #f5f5f5;
        }

        .calendar-day.today {
            background-color: var(--primary-blue);
            color: white;
        }

        .calendar-day.has-sessions {
            position: relative;
        }

        .calendar-day.has-sessions::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--primary-pink);
            border-radius: 50%;
        }

        .calendar-day.selected {
            background-color: var(--primary-purple);
            color: white;
        }

        .calendar-sessions {
            margin-top: 20px;
            display: none;
        }

        .calendar-sessions.visible {
            display: block;
        }

        .session-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .session-time {
            font-size: 0.9rem;
            color: #666;
        }

        .session-duration {
            font-weight: bold;
        }

        .session-project {
            color: var(--primary-purple);
            font-size: 0.9rem;
        }

        .session-notes {
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-purple);
            color: var(--primary-purple);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .history-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .history-type {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .work-history { background-color: var(--work-bg); color: var(--work-text); }
        .break-history { background-color: var(--break-bg); color: var(--break-text); }

        .history-time {
            font-size: 0.9rem;
            color: #666;
        }

        .history-duration {
            font-weight: bold;
        }

        .history-project {
            color: var(--primary-purple);
            font-size: 0.9rem;
        }

        .history-notes {
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .export-btn {
            background-color: var(--primary-green);
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-close {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .full-calendar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .full-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .full-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .full-calendar-day {
            min-height: 80px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .full-calendar-day.has-sessions {
            background-color: #f9f9f9;
        }

        .full-calendar-day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .full-calendar-sessions {
            margin-top: 30px;
        }

        .full-session-item {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .tracking-container {
                grid-template-columns: 1fr;
            }
            
            .timer-display {
                font-size: 3rem;
            }
            
            .timer-controls, .mode-buttons, .quick-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pomodoro Timer</h1>
            <button id="viewCalendar">View Calendar</button>
        </div>

        <div class="timer-container">
            <div class="timer-display" id="timer" contenteditable="true">25:00</div>
            
            <div class="timer-controls">
                <button id="start">Start</button>
                <button id="stop">Stop</button>
                <button id="reset">Reset</button>
            </div>
            
            <div class="mode-buttons">
                <button id="setWorkMode">Work Mode</button>
                <button id="setBreakMode">Break Mode</button>
            </div>
            
            <div class="quick-buttons">
                <button id="work25">25:00</button>
                <button id="break5">5:00</button>
                <button id="break30">30:00</button>
            </div>
        </div>

        <div class="tracking-container">
            <div class="tracking-box">
                <h2>Project Tracking</h2>
                <div class="project-input">
                    <input type="text" id="projectInput" placeholder="New project name">
                    <button id="addProject">Add Project</button>
                </div>
                <div class="project-list" id="projectList">
                    <!-- Projects will be added here -->
                </div>
            </div>
            
            <div class="tracking-box">
                <h2>Calendar</h2>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div id="currentMonthYear">Month Year</div>
                        <div class="calendar-nav">
                            <button id="prevMonth">&lt;</button>
                            <button id="nextMonth">&gt;</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated here -->
                    </div>
                    <div class="calendar-sessions" id="calendarSessions">
                        <!-- Sessions for selected day will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="tracking-box">
            <h2>Session History</h2>
            <div class="tabs">
                <div class="tab active" data-tab="sessions">Sessions</div>
                <div class="tab" data-tab="projects">Projects</div>
            </div>
            
            <div class="tab-content active" id="sessionsTab">
                <div id="sessionHistory">
                    <!-- Session history will be added here -->
                </div>
                <button id="exportSessions" class="export-btn">Export Session History</button>
            </div>
            
            <div class="tab-content" id="projectsTab">
                <div id="projectHistory">
                    <!-- Project history will be added here -->
                </div>
                <button id="exportProjects" class="export-btn">Export Project History</button>
            </div>
        </div>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Session Note</h3>
                <span class="modal-close" id="closeModal">&times;</span>
            </div>
            <textarea id="noteText" placeholder="Enter notes about this session..." rows="5"></textarea>
            <button id="saveNote">Save Note</button>
        </div>
    </div>

    <div class="full-calendar" id="fullCalendar">
        <div class="full-calendar-header">
            <h2 id="fullCalendarTitle">Month Year</h2>
            <div>
                <button id="fullPrevMonth">&lt;</button>
                <button id="fullNextMonth">&gt;</button>
                <button id="closeFullCalendar">Close</button>
            </div>
        </div>
        
        <div class="full-calendar-grid" id="fullCalendarGrid">
            <!-- Full calendar will be generated here -->
        </div>
        
        <div class="full-calendar-sessions" id="fullCalendarSessions">
            <!-- Full calendar sessions will appear here -->
        </div>
    </div>

    <script>
        // State management
        const state = {
            timer: null,
            isRunning: false,
            isWorkMode: true,
            totalSeconds: 25 * 60,
            initialSeconds: 25 * 60,
            sessionStartTime: null,
            projects: [],
            currentProject: null,
            sessionHistory: [],
            calendar: {
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                selectedDate: null
            },
            fullCalendar: {
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                selectedDate: null
            }
        };

        // DOM elements
        const dom = {
            timer: document.getElementById('timer'),
            startBtn: document.getElementById('start'),
            stopBtn: document.getElementById('stop'),
            resetBtn: document.getElementById('reset'),
            workModeBtn: document.getElementById('setWorkMode'),
            breakModeBtn: document.getElementById('setBreakMode'),
            work25Btn: document.getElementById('work25'),
            break5Btn: document.getElementById('break5'),
            break30Btn: document.getElementById('break30'),
            projectInput: document.getElementById('projectInput'),
            addProjectBtn: document.getElementById('addProject'),
            projectList: document.getElementById('projectList'),
            currentMonthYear: document.getElementById('currentMonthYear'),
            calendarGrid: document.getElementById('calendarGrid'),
            calendarSessions: document.getElementById('calendarSessions'),
            prevMonthBtn: document.getElementById('prevMonth'),
            nextMonthBtn: document.getElementById('nextMonth'),
            sessionHistoryContainer: document.getElementById('sessionHistory'),
            projectHistoryContainer: document.getElementById('projectHistory'),
            exportSessionsBtn: document.getElementById('exportSessions'),
            exportProjectsBtn: document.getElementById('exportProjects'),
            noteModal: document.getElementById('noteModal'),
            noteText: document.getElementById('noteText'),
            saveNoteBtn: document.getElementById('saveNote'),
            closeModalBtn: document.getElementById('closeModal'),
            viewCalendarBtn: document.getElementById('viewCalendar'),
            fullCalendar: document.getElementById('fullCalendar'),
            fullCalendarTitle: document.getElementById('fullCalendarTitle'),
            fullCalendarGrid: document.getElementById('fullCalendarGrid'),
            fullCalendarSessions: document.getElementById('fullCalendarSessions'),
            fullPrevMonthBtn: document.getElementById('fullPrevMonth'),
            fullNextMonthBtn: document.getElementById('fullNextMonth'),
            closeFullCalendarBtn: document.getElementById('closeFullCalendar'),
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content')
        };

        // Timer functions
        function startTimer() {
            if (state.isRunning) return;
            
            // Parse time from display
            const timeParts = dom.timer.textContent.split(':');
            let minutes = parseInt(timeParts[0]) || 0;
            let seconds = parseInt(timeParts[1]) || 0;
            
            state.totalSeconds = minutes * 60 + seconds;
            state.initialSeconds = state.totalSeconds;
            
            state.isRunning = true;
            state.sessionStartTime = new Date();
            
            dom.startBtn.style.display = 'none';
            dom.stopBtn.style.display = 'inline-block';
            
            state.timer = setInterval(() => {
                state.totalSeconds--;
                updateTimerDisplay();
                
                if (state.totalSeconds <= 0) {
                    // Timer completed
                    clearInterval(state.timer);
                    dom.startBtn.style.display = 'inline-block';
                    dom.stopBtn.style.display = 'none';
                    
                    // Record the session
                    const sessionEndTime = new Date();
                    const duration = Math.floor((sessionEndTime - state.sessionStartTime) / 1000);
                    
                    const session = {
                        type: state.isWorkMode ? 'work' : 'break',
                        duration: duration,
                        timestamp: state.sessionStartTime,
                        project: state.currentProject ? getProjectById(state.currentProject).name : null,
                        notes: ''
                    };
                    
                    // Show modal to add notes
                    showNoteModal(session);
                    
                    // Switch mode
                    state.isWorkMode = !state.isWorkMode;
                    updateModeDisplay();
                    
                    // Set next timer
                    if (state.isWorkMode) {
                        setTimer(25, 0);
                    } else {
                        // Alternate between short and long breaks
                        const lastBreakWasShort = localStorage.getItem('lastBreakWasShort') === 'true';
                        if (lastBreakWasShort) {
                            setTimer(30, 0);
                            localStorage.setItem('lastBreakWasShort', 'false');
                        } else {
                            setTimer(5, 0);
                            localStorage.setItem('lastBreakWasShort', 'true');
                        }
                    }
                    
                    state.isRunning = false;
                }
            }, 1000);
        }

        function stopTimer() {
            if (!state.isRunning) return;
            
            clearInterval(state.timer);
            state.isRunning = false;
            
            dom.startBtn.style.display = 'inline-block';
            dom.stopBtn.style.display = 'none';
            
            // Record the session
            const sessionEndTime = new Date();
            const duration = Math.floor((sessionEndTime - state.sessionStartTime) / 1000);
            
            const session = {
                type: state.isWorkMode ? 'work' : 'break',
                duration: duration,
                timestamp: state.sessionStartTime,
                project: state.currentProject ? getProjectById(state.currentProject).name : null,
                notes: ''
            };
            
            // Show modal to add notes
            showNoteModal(session);
        }

        function resetTimer() {
            clearInterval(state.timer);
            state.isRunning = false;
            state.totalSeconds = state.initialSeconds;
            updateTimerDisplay();
            
            dom.startBtn.style.display = 'inline-block';
            dom.stopBtn.style.display = 'none';
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(Math.abs(state.totalSeconds) / 60);
            const seconds = Math.abs(state.totalSeconds) % 60;
            const sign = state.totalSeconds < 0 ? '-' : '';
            dom.timer.textContent = `${sign}${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function setTimer(minutes, seconds) {
            state.totalSeconds = minutes * 60 + seconds;
            state.initialSeconds = state.totalSeconds;
            updateTimerDisplay();
        }

        function setMode(isWorkMode) {
            state.isWorkMode = isWorkMode;
            updateModeDisplay();
        }

        function updateModeDisplay() {
            if (state.isWorkMode) {
                dom.workModeBtn.style.backgroundColor = var(--primary-pink);
                dom.breakModeBtn.style.backgroundColor = '#ccc';
            } else {
                dom.workModeBtn.style.backgroundColor = '#ccc';
                dom.breakModeBtn.style.backgroundColor = var(--primary-green);
            }
        }

        // Project functions
        function addProject() {
            const projectName = dom.projectInput.value.trim();
            if (!projectName) return;
            
            const project = {
                id: Date.now().toString(),
                name: projectName,
                sessions: [],
                totalWorkTime: 0,
                totalBreakTime: 0,
                pomodoros: 0
            };
            
            state.projects.push(project);
            saveProjects();
            renderProjects();
            dom.projectInput.value = '';
        }

        function selectProject(projectId) {
            state.currentProject = projectId;
            renderProjects();
        }

        function getProjectById(projectId) {
            return state.projects.find(p => p.id === projectId);
        }

        function saveProjects() {
            localStorage.setItem('projects', JSON.stringify(state.projects));
        }

        function loadProjects() {
            const savedProjects = localStorage.getItem('projects');
            if (savedProjects) {
                state.projects = JSON.parse(savedProjects);
                renderProjects();
            }
        }

        function renderProjects() {
            dom.projectList.innerHTML = '';
            
            state.projects.forEach(project => {
                const projectEl = document.createElement('div');
                projectEl.className = `project-item ${project.id === state.currentProject ? 'selected' : ''}`;
                projectEl.dataset.id = project.id;
                
                projectEl.innerHTML = `
                    <div class="project-header">
                        <div class="project-name">${project.name}</div>
                        <div class="project-stats">
                            <span>🍅 ${project.pomodoros}</span>
                            <span>⏱ ${formatTime(project.totalWorkTime)}</span>
                        </div>
                    </div>
                    <div class="project-notes">
                        ${project.sessions.map(session => `
                            <div class="note-item">
                                <div class="note-time">${new Date(session.timestamp).toLocaleString()}</div>
                                <div class="note-text">${session.notes}</div>
                            </div>
                        `).join('')}
                        <div class="add-note">
                            <input type="text" placeholder="Add note to project...">
                            <button class="add-project-note">Add</button>
                        </div>
                    </div>
                `;
                
                projectEl.addEventListener('click', () => {
                    projectEl.classList.toggle('expanded');
                });
                
                dom.projectList.appendChild(projectEl);
                
                // Add event listener for the add note button
                const addNoteBtn = projectEl.querySelector('.add-project-note');
                const noteInput = projectEl.querySelector('.add-note input');
                
                addNoteBtn.addEventListener('click', () => {
                    const noteText = noteInput.value.trim();
                    if (noteText) {
                        project.sessions.push({
                            timestamp: new Date(),
                            notes: noteText
                        });
                        saveProjects();
                        renderProjects();
                        noteInput.value = '';
                    }
                });
            });
        }

        // Session history functions
        function addSession(session) {
            state.sessionHistory.push(session);
            
            // Update project stats if this is a work session with a project
            if (session.type === 'work' && session.project) {
                const project = state.projects.find(p => p.name === session.project);
                if (project) {
                    project.pomodoros++;
                    project.totalWorkTime += session.duration;
                    project.sessions.push({
                        timestamp: session.timestamp,
                        notes: session.notes,
                        duration: session.duration
                    });
                    saveProjects();
                }
            }
            
            saveSessionHistory();
            renderSessionHistory();
            renderProjectHistory();
            renderCalendar();
            renderFullCalendar();
        }

        function saveSessionHistory() {
            localStorage.setItem('sessionHistory', JSON.stringify(state.sessionHistory));
        }

        function loadSessionHistory() {
            const savedHistory = localStorage.getItem('sessionHistory');
            if (savedHistory) {
                state.sessionHistory = JSON.parse(savedHistory);
                renderSessionHistory();
                renderProjectHistory();
            }
        }

        function renderSessionHistory() {
            dom.sessionHistoryContainer.innerHTML = '';
            
            if (state.sessionHistory.length === 0) {
                dom.sessionHistoryContainer.innerHTML = '<p>No session history yet</p>';
                return;
            }
            
            // Sort by most recent first
            const sortedHistory = [...state.sessionHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedHistory.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'history-item';
                
                sessionEl.innerHTML = `
                    <div class="history-header">
                        <span class="history-type ${session.type}-history">${session.type.charAt(0).toUpperCase() + session.type.slice(1)}</span>
                        <span class="history-time">${new Date(session.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="history-duration">Duration: ${formatTime(session.duration)}</div>
                    ${session.project ? `<div class="history-project">Project: ${session.project}</div>` : ''}
                    ${session.notes ? `<div class="history-notes">${session.notes}</div>` : ''}
                `;
                
                dom.sessionHistoryContainer.appendChild(sessionEl);
            });
        }

        function renderProjectHistory() {
            dom.projectHistoryContainer.innerHTML = '';
            
            if (state.projects.length === 0) {
                dom.projectHistoryContainer.innerHTML = '<p>No projects yet</p>';
                return;
            }
            
            state.projects.forEach(project => {
                const projectEl = document.createElement('div');
                projectEl.className = 'history-item';
                
                // Calculate stats for this project
                const projectSessions = state.sessionHistory.filter(s => s.project === project.name);
                const workSessions = projectSessions.filter(s => s.type === 'work');
                const breakSessions = projectSessions.filter(s => s.type === 'break');
                
                const totalWorkTime = workSessions.reduce((sum, s) => sum + s.duration, 0);
                const totalBreakTime = breakSessions.reduce((sum, s) => sum + s.duration, 0);
                
                projectEl.innerHTML = `
                    <div class="project-name">${project.name}</div>
                    <div>Pomodoros: ${workSessions.length}</div>
                    <div>Work Time: ${formatTime(totalWorkTime)}</div>
                    <div>Break Time: ${formatTime(totalBreakTime)}</div>
                    <div>Last Session: ${project.sessions.length > 0 ? 
                        new Date(project.sessions[project.sessions.length - 1].timestamp).toLocaleString() : 'Never'}</div>
                `;
                
                dom.projectHistoryContainer.appendChild(projectEl);
            });
        }

        function exportSessionHistory() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add header
            csvContent += "Type,Date,Duration,Project,Notes\n";
            
            // Add data
            state.sessionHistory.forEach(session => {
                const row = [
                    session.type,
                    new Date(session.timestamp).toLocaleString(),
                    formatTime(session.duration),
                    session.project || '',
                    session.notes || ''
                ].join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "pomodoro_sessions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportProjectHistory() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add header
            csvContent += "Project,Pomodoros,Work Time,Break Time,Last Session\n";
            
            // Add data
            state.projects.forEach(project => {
                const projectSessions = state.sessionHistory.filter(s => s.project === project.name);
                const workSessions = projectSessions.filter(s => s.type === 'work');
                const breakSessions = projectSessions.filter(s => s.type === 'break');
                
                const totalWorkTime = workSessions.reduce((sum, s) => sum + s.duration, 0);
                const totalBreakTime = breakSessions.reduce((sum, s) => sum + s.duration, 0);
                const lastSession = project.sessions.length > 0 ? 
                    new Date(project.sessions[project.sessions.length - 1].timestamp).toLocaleString() : 'Never';
                
                const row = [
                    project.name,
                    workSessions.length,
                    formatTime(totalWorkTime),
                    formatTime(totalBreakTime),
                    lastSession
                ].join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "pomodoro_projects.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Calendar functions
        function renderCalendar(container = dom.calendarGrid, titleElement = dom.currentMonthYear) {
            const month = state.calendar.currentMonth;
            const year = state.calendar.currentYear;
            
            // Set month/year display
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            titleElement.textContent = `${monthNames[month]} ${year}`;
            
            // Clear previous calendar days
            while (container.children.length > 7) {
                container.removeChild(container.lastChild);
            }
            
            // Get first day of month and total days in month
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                container.appendChild(emptyCell);
            }
            
            // Add cells for each day of the month
            const today = new Date();
            const currentDate = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                // Check if this day has any sessions
                const hasSessions = state.sessionHistory.some(session => {
                    const sessionDate = new Date(session.timestamp);
                    return sessionDate.getDate() === day && 
                           sessionDate.getMonth() === month && 
                           sessionDate.getFullYear() === year;
                });
                
                if (hasSessions) {
                    dayCell.classList.add('has-sessions');
                }
                
                // Highlight today
                if (day === currentDate && month === currentMonth && year === currentYear) {
                    dayCell.classList.add('today');
                }
                
                // Highlight selected date
                if (state.calendar.selectedDate && 
                    day === state.calendar.selectedDate.getDate() && 
                    month === state.calendar.selectedDate.getMonth() && 
                    year === state.calendar.selectedDate.getFullYear()) {
                    dayCell.classList.add('selected');
                }
                
                dayCell.addEventListener('click', () => {
                    const selectedDate = new Date(year, month, day);
                    state.calendar.selectedDate = selectedDate;
                    renderCalendar();
                    showSessionsForDate(selectedDate, dom.calendarSessions);
                });
                
                container.appendChild(dayCell);
            }
            
            // Show sessions for selected date if any
            if (state.calendar.selectedDate) {
                showSessionsForDate(state.calendar.selectedDate, dom.calendarSessions);
            }
        }

        function renderFullCalendar() {
            const month = state.fullCalendar.currentMonth;
            const year = state.fullCalendar.currentYear;
            
            // Set month/year display
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            dom.fullCalendarTitle.textContent = `${monthNames[month]} ${year}`;
            
            // Clear previous calendar days
            dom.fullCalendarGrid.innerHTML = '';
            
            // Add day headers
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                dom.fullCalendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and total days in month
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'full-calendar-day empty';
                dom.fullCalendarGrid.appendChild(emptyCell);
            }
            
            // Add cells for each day of the month
            const today = new Date();
            const currentDate = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'full-calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'full-calendar-day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Check if this day has any sessions
                const daySessions = state.sessionHistory.filter(session => {
                    const sessionDate = new Date(session.timestamp);
                    return sessionDate.getDate() === day && 
                           sessionDate.getMonth() === month && 
                           sessionDate.getFullYear() === year;
                });
                
                if (daySessions.length > 0) {
                    dayCell.classList.add('has-sessions');
                    
                    // Add session count
                    const sessionCount = document.createElement('div');
                    sessionCount.className = 'full-calendar-session-count';
                    sessionCount.textContent = `${daySessions.length} session${daySessions.length > 1 ? 's' : ''}`;
                    dayCell.appendChild(sessionCount);
                }
                
                // Highlight today
                if (day === currentDate && month === currentMonth && year === currentYear) {
                    dayCell.classList.add('today');
                }
                
                // Highlight selected date
                if (state.fullCalendar.selectedDate && 
                    day === state.fullCalendar.selectedDate.getDate() && 
                    month === state.fullCalendar.selectedDate.getMonth() && 
                    year === state.fullCalendar.selectedDate.getFullYear()) {
                    dayCell.classList.add('selected');
                }
                
                dayCell.addEventListener('click', () => {
                    const selectedDate = new Date(year, month, day);
                    state.fullCalendar.selectedDate = selectedDate;
                    renderFullCalendar();
                    showSessionsForDate(selectedDate, dom.fullCalendarSessions);
                });
                
                dom.fullCalendarGrid.appendChild(dayCell);
            }
            
            // Show sessions for selected date if any
            if (state.fullCalendar.selectedDate) {
                showSessionsForDate(state.fullCalendar.selectedDate, dom.fullCalendarSessions);
            }
        }

        function showSessionsForDate(date, container) {
            container.innerHTML = '';
            
            const sessionsForDate = state.sessionHistory.filter(session => {
                const sessionDate = new Date(session.timestamp);
                return sessionDate.getDate() === date.getDate() && 
                       sessionDate.getMonth() === date.getMonth() && 
                       sessionDate.getFullYear() === date.getFullYear();
            });
            
            if (sessionsForDate.length === 0) {
                container.innerHTML = '<p>No sessions for this date</p>';
                return;
            }
            
            // Sort by time
            sessionsForDate.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            sessionsForDate.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'full-session-item';
                
                sessionEl.innerHTML = `
                    <div class="session-time">${new Date(session.timestamp).toLocaleTimeString()}</div>
                    <div class="session-duration">${formatTime(session.duration)} ${session.type}</div>
                    ${session.project ? `<div class="session-project">Project: ${session.project}</div>` : ''}
                    ${session.notes ? `<div class="session-notes">${session.notes}</div>` : ''}
                `;
                
                container.appendChild(sessionEl);
            });
            
            container.style.display = 'block';
            container.classList.add('visible');
        }

        function changeMonth(offset, isFullCalendar = false) {
            if (isFullCalendar) {
                state.fullCalendar.currentMonth += offset;
                
                // Handle year wrap-around
                if (state.fullCalendar.currentMonth < 0) {
                    state.fullCalendar.currentMonth = 11;
                    state.fullCalendar.currentYear--;
                } else if (state.fullCalendar.currentMonth > 11) {
                    state.fullCalendar.currentMonth = 0;
                    state.fullCalendar.currentYear++;
                }
                
                state.fullCalendar.selectedDate = null;
                renderFullCalendar();
                dom.fullCalendarSessions.innerHTML = '<p>Select a date to view sessions</p>';
            } else {
                state.calendar.currentMonth += offset;
                
                // Handle year wrap-around
                if (state.calendar.currentMonth < 0) {
                    state.calendar.currentMonth = 11;
                    state.calendar.currentYear--;
                } else if (state.calendar.currentMonth > 11) {
                    state.calendar.currentMonth = 0;
                    state.calendar.currentYear++;
                }
                
                state.calendar.selectedDate = null;
                renderCalendar();
                dom.calendarSessions.innerHTML = '<p>Select a date to view sessions</p>';
            }
        }

        // Utility functions
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function showNoteModal(session) {
            dom.noteText.value = '';
            dom.noteModal.style.display = 'flex';
            
            dom.saveNoteBtn.onclick = () => {
                const noteText = dom.noteText.value.trim();
                if (noteText) {
                    session.notes = noteText;
                    addSession(session);
                }
                dom.noteModal.style.display = 'none';
            };
        }

        // Event listeners
        function setupEventListeners() {
            // Timer controls
            dom.startBtn.addEventListener('click', startTimer);
            dom.stopBtn.addEventListener('click', stopTimer);
            dom.resetBtn.addEventListener('click', resetTimer);
            
            // Mode buttons
            dom.workModeBtn.addEventListener('click', () => setMode(true));
            dom.breakModeBtn.addEventListener('click', () => setMode(false));
            
            // Quick timer buttons
            dom.work25Btn.addEventListener('click', () => setTimer(25, 0));
            dom.break5Btn.addEventListener('click', () => setTimer(5, 0));
            dom.break30Btn.addEventListener('click', () => setTimer(30, 0));
            
            // Project controls
            dom.addProjectBtn.addEventListener('click', addProject);
            dom.projectInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addProject();
            });
            
            // Calendar controls
            dom.prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            dom.nextMonthBtn.addEventListener('click', () => changeMonth(1));
            
            // Full calendar controls
            dom.fullPrevMonthBtn.addEventListener('click', () => changeMonth(-1, true));
            dom.fullNextMonthBtn.addEventListener('click', () => changeMonth(1, true));
            dom.closeFullCalendarBtn.addEventListener('click', () => {
                dom.fullCalendar.style.display = 'none';
            });
            dom.viewCalendarBtn.addEventListener('click', () => {
                dom.fullCalendar.style.display = 'block';
                renderFullCalendar();
            });
            
            // History export
            dom.exportSessionsBtn.addEventListener('click', exportSessionHistory);
            dom.exportProjectsBtn.addEventListener('click', exportProjectHistory);
            
            // Modal controls
            dom.closeModalBtn.addEventListener('click', () => {
                dom.noteModal.style.display = 'none';
            });
            
            // Tab controls
            dom.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Set active tab
                    dom.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const tabType = tab.getAttribute('data-tab');
                    dom.tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabType}Tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Timer display edit handling
            dom.timer.addEventListener('blur', function() {
                const timeParts = this.textContent.split(':');
                let minutes = parseInt(timeParts[0]) || 0;
                let seconds = parseInt(timeParts[1]) || 0;
                
                // Validate input
                if (isNaN(minutes)) minutes = 0;
                if (isNaN(seconds)) seconds = 0;
                
                // Ensure seconds are between 0-59
                seconds = Math.min(59, Math.max(0, seconds));
                
                // Update display with validated values
                this.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update state
                state.totalSeconds = minutes * 60 + seconds;
                state.initialSeconds = state.totalSeconds;
            });
        }

        // Initialize
        function init() {
            loadProjects();
            loadSessionHistory();
            setupEventListeners();
            updateModeDisplay();
            renderCalendar();
            
            // Set today as selected date
            const today = new Date();
            state.calendar.selectedDate = today;
            state.fullCalendar.selectedDate = today;
            
            // Show today's sessions
            showSessionsForDate(today, dom.calendarSessions);
        }

        init();
    </script>
</body>
</html>
